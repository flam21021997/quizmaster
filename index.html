<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quiz Master Pegaso</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  background: #f2f2f7;
  padding: 20px;
}
.card {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
}
button {
  width: 100%;
  padding: 14px;
  margin: 6px 0;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  background: #007aff;
  color: white;
}
button.correct { background: #34c759; }
button.wrong { background: #ff3b30; }
button.secondary { background: #5856d6; }
.hidden { display:none; }
#top { font-size:14px; color:#555; margin-bottom:6px; }
</style>
</head>

<body>

<div class="card">
  <div id="top"></div>
  <h2 id="question"></h2>
  <div id="answers"></div>
  <button id="nextBtn" class="secondary hidden">Avanti</button>
  <button id="startExamBtn">üéØ Simulazione Test</button>
  <button id="exitExamBtn" class="secondary hidden">‚¨ÖÔ∏è Torna allo studio</button>
</div>

<script src="questions_1.js"></script>
<script src="questions_2.js"></script>
<script src="questions_3.js"></script>

<script>
const QUESTIONS = [...questions_1, ...questions_2, ...questions_3];

// inizializza metriche
QUESTIONS.forEach(q=>{
  q._seen ??= 0;
  q._wrong ??= 0;
});

// =======================
// SELEZIONE INTELLIGENTE STUDIO
// =======================
let cycleCount = 0;

function pickStudyQuestion(){
  // FASE 1: mai viste
  const unseen = QUESTIONS.filter(q=>q._seen === 0);
  if(unseen.length) return unseen[Math.floor(Math.random()*unseen.length)];

  // FASE 1b: viste una volta
  const once = QUESTIONS.filter(q=>q._seen === 1);
  if(once.length) return once[Math.floor(Math.random()*once.length)];

  // FASE 2: 3 difficili + 1 facile
  cycleCount++;
  const sorted = [...QUESTIONS].sort((a,b)=>{
    const da = a._seen ? a._wrong/a._seen : 0;
    const db = b._seen ? b._wrong/b._seen : 0;
    return db-da;
  });

  if(cycleCount % 4 !== 0) {
    return sorted[0]; // difficile
  } else {
    return sorted[Math.floor(sorted.length*0.7)]; // facile
  }
}

// =======================
// STATO
// =======================
let mode="study";
let current=null;
let answered=false;
let done=0;

// =======================
// RENDER
// =======================
function renderStudy(){
  mode="study";
  answered=false;
  document.getElementById("nextBtn").classList.add("hidden");
  document.getElementById("exitExamBtn").classList.add("hidden");
  document.getElementById("startExamBtn").classList.remove("hidden");

  current = pickStudyQuestion();
  current._seen++;

  document.getElementById("top").innerText =
    `Studio ‚Äî fatte: ${done} | Errori domanda: ${current._wrong}/${current._seen}`;

  document.getElementById("question").innerText = current.q;
  renderAnswers(current);
}

function renderAnswers(q){
  const box=document.getElementById("answers");
  box.innerHTML="";
  [...q.wrong, q.correct].sort(()=>Math.random()-0.5)
    .forEach(a=>{
      const b=document.createElement("button");
      b.innerText=a;
      b.onclick=()=>answer(a,b);
      box.appendChild(b);
    });
}

// =======================
// RISPOSTA
// =======================
function answer(ans,btn){
  if(answered) return;
  answered=true;
  done++;

  document.querySelectorAll("#answers button").forEach(b=>b.disabled=true);

  if(ans===current.correct){
    btn.classList.add("correct");
  } else {
    btn.classList.add("wrong");
    current._wrong++;
    document.querySelectorAll("#answers button")
      .forEach(b=>{ if(b.innerText===current.correct) b.classList.add("correct");});
  }

  document.getElementById("nextBtn").classList.remove("hidden");
}

// =======================
// SIMULAZIONE TEST
// =======================
let exam=[], examIdx=0, examScore=0, wrongList=[];

function startExam(){
  mode="exam";
  exam=[...QUESTIONS].sort(()=>Math.random()-0.5).slice(0,30);
  examIdx=0; examScore=0; wrongList=[];
  document.getElementById("startExamBtn").classList.add("hidden");
  document.getElementById("exitExamBtn").classList.remove("hidden");
  renderExam();
}

function renderExam(){
  answered=false;
  current=exam[examIdx];
  document.getElementById("top").innerText =
    `Simulazione ‚Äî ${examIdx+1}/30`;
  document.getElementById("question").innerText=current.q;
  renderAnswers(current);
}

function finishExam(){
  let html=`<h3>Risultato: ${examScore}/30</h3><h4>Domande sbagliate:</h4>`;
  wrongList.forEach(w=>{
    html+=`<p><b>${w.q}</b><br>‚úîÔ∏è ${w.correct}</p>`;
  });
  document.getElementById("question").innerHTML=html;
  document.getElementById("answers").innerHTML="";
}

// override answer per esame
const oldAnswer=answer;
answer=function(ans,btn){
  if(mode==="study") return oldAnswer(ans,btn);

  if(answered) return;
  answered=true;
  document.querySelectorAll("#answers button").forEach(b=>b.disabled=true);

  if(ans===current.correct){
    examScore++;
    btn.classList.add("correct");
  } else {
    btn.classList.add("wrong");
    wrongList.push(current);
    document.querySelectorAll("#answers button")
      .forEach(b=>{ if(b.innerText===current.correct) b.classList.add("correct");});
  }

  setTimeout(()=>{
    examIdx++;
    examIdx>=30 ? finishExam() : renderExam();
  },800);
};

// =======================
document.getElementById("nextBtn").onclick=renderStudy;
document.getElementById("startExamBtn").onclick=startExam;
document.getElementById("exitExamBtn").onclick=renderStudy;

renderStudy();
</script>
</body>
</html>

